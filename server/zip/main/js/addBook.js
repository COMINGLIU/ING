!function(d,t){var r=t,i=d.location.search.split("?")[1].split("&")[0].split("=")[1],s=r.getElementById("uped"),m=s.getElementsByClassName("bookInfo"),p={imgFile:r.getElementsByName("bookImg"),href:s.getElementsByTagName("a"),img:s.getElementsByTagName("img"),name:r.getElementsByName("bookName"),num:r.getElementsByName("bookNum"),public:r.getElementsByName("bookPublish"),class:r.getElementsByName("bookClass"),price:r.getElementsByName("bookPrice"),describe:r.getElementsByName("bookDes")};function f(){this.init(),this.openAddBook(),this.aboutHeader(),this.logo()}Object.defineProperty(f.prototype,"constructor",{enumerable:!1,value:f}),f.prototype={init:function(){var e=d.location.search.split("?")[1],o=e.split("&")[0].split("=")[1],n=e.split("&")[1].split("=")[1];this.getCookieModule(function(e){e.get("user")?(e.get("user"),f.prototype.getAjaxModule(function(e){e({url:"/",data:{act:"getOneAllStoreBooksForShopper",shopperId:o},method:"get",error:function(e){console.log("err:"+e)},success:function(e){if(e=JSON.parse(e),console.log(e),"success"==e.status){r.getElementById("userName").innerHTML=e.shopperName+" ("+n+")";var t=e.data;f.prototype.renderData(t),f.prototype.delBook(),f.prototype.editBookInfo(),f.prototype.addBook(t),f.prototype.gotoStore(o)}else alert("您请求的信息不存在")}})})):confirm("您还没登陆，不能进行任何操作,点击确定前往首页登录")&&(d.location.href="index.html")})},renderData:function(e){if(e.length<m.length){var t=r.querySelectorAll("#uped .bookInfo");if(0==e.length)for(var o=1,n=t.length;o<n;o++)s.removeChild(t[o]);else for(o=e.length,n=t.length;o<n;o++)s.removeChild(t[o])}else if(e.length>m.length){var a=r.createDocumentFragment();for(o=m.length,n=e.length;o<n;o++){var l=m[0].cloneNode(!0);a.appendChild(l)}s.appendChild(a)}for(o=0,n=m.length;o<n;o++)p.href[o].href+=e[o].bookId,p.img[o].src="imgs/storeImg/"+e[o].bookSrc,p.name[o].value=e[o].bookName,p.num[o].value=e[o].bookAllNum,p.public[o].value=e[o].bookPublic,p.class[o].value=e[o].bookType,p.price[o].value=e[o].bookPrice,p.describe[o].value=e[o].bookDescribe},delBook:function(){for(var n=r.getElementById("uped"),a=r.querySelectorAll("#uped>li"),e=n.getElementsByClassName("del"),t=0,o=e.length;t<o;t++)!function(t){var o=p.href[t].href.split("?")[1].split("=")[1];e[t].onclick=function(){confirm("确认下架该书籍吗?删除之后它将从您的书店移除")&&f.prototype.getAjaxModule(function(e){e({url:"/",data:{act:"delShopperBook",bookId:o},method:"get",error:function(e){console.log("err:"+e)},success:function(e){e=JSON.parse(e),console.log(e),"success"==e.status&&(f.prototype.editOkInfo("删除成功"),n.removeChild(a[t]),f.prototype.editBookInfo())}})})}}(t)},addBook:function(){var t,o,n=r.querySelector("#add form"),e={bookImg:r.getElementsByName("add-bookImg")[0],bookName:r.getElementsByName("add-bookName")[0],bookAllNum:r.getElementsByName("add-bookNum")[0],bookPublic:r.getElementsByName("add-bookPublish")[0],bookClass:r.getElementsByName("add-bookClass")[0],bookPrice:r.getElementsByName("add-bookPrice")[0],bookDes:n.getElementsByTagName("textarea")[0]},a=r.querySelector("#add-img img"),l=r.getElementsByName("submit")[0];r.getElementsByName("cancel")[0];e.bookImg.onchange=function(){console.log(this.files[0]),t=this.files[0],(o=new FormData).append("act","addBook"),o.append("shopperId",i),o.append("userName","QPQ"),o.append("bookImg",t);var e=new FileReader(t);e.readAsDataURL(t),e.onload=function(){a.src=this.result}},n.onsubmit=function(e){(e=e||d.e).preventDefault?e.preventDefault():e.returnValue=!1},l.onclick=function(){o.append("bookName",e.bookName.value),o.append("bookAllNum",e.bookAllNum.value),o.append("bookPublic",e.bookPublic.value),o.append("bookClass",e.bookClass.value),o.append("bookPrice",e.bookPrice.value),o.append("bookDes",e.bookDes.value);var t=f.prototype.createXHR();t.onreadystatechange=function(){if(4==t.readyState)if(200<=t.status&&t.status<300||304==t.status){var e=JSON.parse(t.responseText);console.log(e),"success"==e.status?(alert(e.msg),n.reset(),a.src=""):alert(e.msg)}else alert("error:"+t.status)},t.open("post","/",!0),t.send(o)}},openAddBook:function(){var e=r.getElementById("addBtn"),t=r.getElementById("delBtn"),o=r.getElementById("add");e.onclick=function(){o.style.height="700px",e.innerHTML="-",t.innerHTML="-"},t.onclick=function(){o.style.height="0",e.innerHTML="+",t.innerHTML="+"}},aboutHeader:function(){var e=r.getElementById("header");d.onscroll=function(){100<t.documentElement.scrollTop?e.style.boxShadow="0 0 10px #ccc":e.style.boxShadow="0 0 0 transparent"}},editBookInfo:function(){for(var t=r.getElementsByClassName("icon-edit-square"),o=r.querySelectorAll(".bookInfo form"),e=0,n=t.length;e<n;e++)!function(n){var a,l,r=m[n].getElementsByTagName("input"),i=m[n].getElementsByTagName("textarea")[0],s=m[n].getElementsByTagName("button"),c=m[n].querySelector("li:first-child"),e=p.href[n].href.split("?")[1].split("=")[1],u={bookSrc:p.imgFile[n],bookName:p.name[n],bookAllNum:p.num[n],bookPublic:p.public[n],bookType:p.class[n],bookPrice:p.price[n],bookDescribe:p.describe[n]};a=new FormData,o[n].onsubmit=function(e){(e=e||d.e).preventDefault?e.preventDefault():e.returnValue=!1},t[n].onclick=function(){i.readOnly=!1;for(var e=0,t=r.length;e<t;e++)r[e].readOnly=!1,r[e].style.borderBottom="1px solid #ccc",s[0].style.width="auto",s[1].style.width="auto",c.style.visibility="visible";for(var o in u)!function(e){u[e].onchange=function(){a.has(e)?a.set(e,u[e].value):a.append(e,u[e].value)}}(o);p.imgFile[n].onchange=function(){l=this.files[0];var e=new FileReader(l);e.readAsDataURL(l),e.onload=function(){p.img[n].src=this.result},a.append("bookNewImg",l)}},s[0].onclick=function(){a.has("act")?a.set("act","editBookInfo"):a.append("act","editBookInfo"),a.has("bookId")?a.set("bookId",e):a.append("bookId",e);var o=f.prototype.createXHR();o.onreadystatechange=function(){if(4==o.readyState&&(200<=o.status&&o.status<300||304==o.status))if("success"==JSON.parse(o.responseText).status){f.prototype.editOkInfo("修改成功"),i.readOnly=!1;for(var e=0,t=r.length;e<t;e++)r[e].readOnly=!0,r[e].style.borderBottom="0",s[0].style.width="0",s[1].style.width="0",c.style.visibility="hidden"}else alert("修改失败,请稍候重试")},o.open("post","/",!0),o.send(a)},s[1].onclick=function(){i.readOnly=!0;for(var e=0,t=r.length;e<t;e++)r[e].readOnly=!0,r[e].style.borderBottom="0",s[0].style.width="0",s[1].style.width="0",c.style.visibility="hidden"}}(e)},editOkInfo:function(e){var t=r.getElementById("editOkInfo");t.innerHTML=e,t.style.opacity="1";var o=setTimeout(function(){t.style.opacity="0",clearTimeout(o)},1500)},logo:function(){r.getElementById("logo").onclick=function(){d.location.href="index.html"}},gotoStore:function(e){r.getElementById("userName").onclick=function(){d.location.href="them1.html?storeId="+e}},createXHR:function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject){if("string"!=typeof arguments.callee.activeXString)for(var e=["MSXML2.XMLHttp.6.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp"],t=0,o=e.length;t<o;t++)try{new ActiveXObject(e[t]),arguments.callee.activeXString=e[t];break}catch(e){throw new Error}return new ActiveXObject(arguments.callee.activeXString)}throw new Error("No XHR object available")},getAjaxModule:function(t){seajs.use("ajax.js",function(e){t&&t(e)})},getCookieModule:function(t){seajs.use("cookie.js",function(e){t&&t(e)})}};new f}(window,document);