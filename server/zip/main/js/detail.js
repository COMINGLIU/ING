!function(e,o){var u,m=document;function g(){this.init(),this.getHeaderModule(),this.getDoEventModule(),this.getAddStore()}Object.defineProperty(g.prototype,"constructor",{enumerable:!1,value:g}),g.prototype={init:function(){var s={img:m.querySelector("#bookinfo .bookimg img"),name:m.querySelector(".bookins h3"),price:m.querySelector(".bookins .price span"),bookNum:m.querySelector(".bookins .book-num span"),bookPublic:m.querySelector(".bookins .book-public span"),bookTel:m.querySelector(".bookins .book-tel span"),bookDescribe:m.querySelector(".bookins .book-describe span")},l=m.getElementById("collect"),a=0,i=m.querySelector("#relaBooks-box ul"),c=(i.querySelectorAll("li"),e.location.search.split("?")[1].split("=")[1]);g.prototype.getCookieModule(function(e){e.get("user")&&(u=JSON.parse(e.get("user")))}),this.getAjaxModule(function(e){e({url:"/",data:{act:"getBookDetail",bookId:c},method:"get",error:function(e){console.log("error:"+e)},success:function(e){e=JSON.parse(e);if(console.log(e),"success"==e.status){if(s.img.src="imgs/storeImg/"+e.bookDetail.bookSrc,s.name.innerHTML=e.bookDetail.bookName,s.price.innerHTML=e.bookDetail.bookPrice,s.bookNum.innerHTML=e.bookDetail.bookAllNum,s.bookPublic.innerHTML=e.bookDetail.bookPublic,s.bookTel.innerHTML=e.bookDetail.tel,s.bookDescribe.innerHTML=e.bookDetail.bookDescribe,0<e.anotherBook.length){for(var o=m.createDocumentFragment(),t=0,n=e.anotherBook.length;t<n;t++){var r=m.createElement("li");r.innerHTML='<li><a href="detail.html?bookId='+e.anotherBook[t].bookId+'" target="blank"><img src="imgs/storeImg/'+e.anotherBook[t].bookSrc+'" alt="otherbook"></a><p>'+e.anotherBook[t].bookName+"</p></li>",o.appendChild(r)}i.appendChild(o)}l.onclick=function(){g.prototype.getCookieModule(function(e){e.get("user")?(u=JSON.parse(e.get("user")),++a%2==1?(l.style.color="#900",g.prototype.getAjaxModule(function(e){e({url:"/",data:{act:"collectBook",userId:u.userId,bookId:c},method:"get",error:function(e){console.log("err:"+e)},success:function(e){e=JSON.parse(e),console.log(e),"success"==e.status?g.prototype.getLikeInfo("收藏成功"):g.prototype.getLikeInfo("收藏失败")}})})):l.style.color="#000"):confirm("登录后收藏才能保存，登录吗?")&&(m.getElementById("regitLog").style.display="block",m.getElementsByClassName("login")[0].style.display="block")})},g.prototype.getComment(c,e.bookDetail)}}})})},getComment:function(t,e){var n=m.querySelector("#comments ul"),r=m.getElementById("comments-n");this.getAjaxModule(function(e){e({url:"/",data:{act:"getBookComment",bookId:t},method:"get",error:function(e){console.log("error："+e)},success:function(e){e=JSON.parse(e);if(console.log(e),"success"==e.status){var o=e.data;r.innerHTML=o.length,g.prototype.renderBookComment(o,n),g.prototype.replyComment(),g.prototype.addComment(t,n,r),g.prototype.delReply(r)}else console.log("书籍评论获取失败")}})})},addComment:function(o,t,n){var r=m.getElementsByName("add-comment-content")[0];m.querySelector("#add-comment button").onclick=function(){""!=r.value&&g.prototype.getCookieModule(function(e){e.get("user")?(u=JSON.parse(e.get("user")),g.prototype.getAjaxModule(function(e){e({url:"/",data:{act:"addBookComment",bookId:o,askUserId:u.userId,askUserName:u.userName,askContent:r.value},method:"post",error:function(e){console.log("err:"+e)},success:function(e){if(e=JSON.parse(e),console.log(e),e.status="success"){g.prototype.getLikeInfo("评论成功"),n.innerHTML=parseInt(n.innerHTML)+1;var o=m.createElement("li");o.innerHTML="<h3>"+u.userName+"</h3>"+r.value+"<p>"+g.prototype.getNowTime()+'</p><em class="delComment">删除</em>',o.setAttribute("data-askId",e.askId),o.setAttribute("data-userId",u.userId),t.appendChild(o),r.value="",g.prototype.delReply()}else g.prototype.getLikeInfo("评论失败")}})})):confirm("您还没登陆，登录即可发表评论，登录吗?")&&(m.getElementById("regitLog").style.display="block",m.getElementsByClassName("login")[0].style.display="block")})}},replyComment:function(){var o=m.getElementsByClassName("reply");aReplyLi=m.querySelectorAll("#comments ul li"),aCommentName=m.querySelectorAll("#comments ul li h3"),commentContent=m.getElementsByName("add-comment-content")[0],oSub=m.querySelector("#add-comment button");for(var e=0,t=o.length;e<t;e++)!function(e){o[e].onclick=function(){commentContent.focus(),commentContent.value="@"+aCommentName[e].innerHTML+"\n"}}(e)},delReply:function(t){for(var n=m.querySelector("#comments ul"),r=m.querySelectorAll(".delComment"),e=0,o=r.length;e<o;e++)!function(e){var o=r[e].parentNode.getAttribute("data-askId");r[e].onclick=function(){confirm("确定删除该评论吗")&&(g.prototype.getAjaxModule(function(e){e({url:"/",data:{act:"delBookComment",askId:o},method:"get",error:function(e){alert("删除失败，请稍候重试")},success:function(e){e=JSON.parse(e),console.log(e),"success"==e.status?(g.prototype.getLikeInfo("删除成功"),t.innerHTML=parseInt(t.innerHTML)-1):g.prototype.getLikeInfo("删除失败")}})}),n.removeChild(r[e].parentNode))}}(e)},renderBookComment:function(e,o){var t=m.createDocumentFragment();console.log("user:"+u);for(var n=0,r=e.length;n<r;n++){var s=m.createElement("li");e[n].toWhoName?e[n].askUserName+"@"+e[n].toWhoName:e[n].askUserName,u&&e[n].askUserId==u.userId?s.innerHTML="<h3>"+e[n].askUserName+"</h3>"+e[n].askContent+"<p>"+e[n].askTime+'</p><em class="delComment">删除</em>':s.innerHTML="<h3>"+e[n].askUserName+"</h3>"+e[n].askContent+"<p>"+e[n].askTime+'</p><em class="reply">回复</em>',s.setAttribute("data-askId",e[n].askId),s.setAttribute("data-userId",e[n].askUserId),t.appendChild(s),o.appendChild(t)}},getLikeInfo:function(e){var o=m.getElementById("likeInfo");o.innerHTML=e,o.style.opacity="1";setTimeout(function(){o.style.opacity="0"},1e3)},getHeaderModule:function(){seajs.use("header.js",function(e){e.headerEvent(),e.regitLogin(),e.scrollHeader()})},getNowTime:function(){var e=new Date;return e.getFullYear()+"-"+((e.getMonth()+1).toString().length<2?"0"+(e.getMonth()+1).toString():e.getMonth()+1)+"-"+(e.getDate().toString().length<2?"0"+e.getDate().toString():e.getDate())+" "+(e.getHours().toString().length<2?"0"+e.getHours().toString():e.getHours())+":"+(e.getMinutes().toString().length<2?"0"+e.getMinutes().toString():e.getMinutes())+":"+(e.getSeconds().toString().length<2?"0"+e.getSeconds().toString():e.getSeconds())},getDoEventModule:function(){seajs.use("doEvent.js",function(e){console.log(e)})},getAddStore:function(){seajs.use("addStore.js",function(e){})},getAjaxModule:function(o){seajs.use("ajax.js",function(e){o&&o(e)})},getCookieModule:function(o){seajs.use("cookie.js",function(e){o&&o(e)})}};new g}(window);